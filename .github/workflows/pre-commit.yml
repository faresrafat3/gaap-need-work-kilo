name: Pre-commit

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  pre-commit:
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for proper change detection

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Cache pre-commit hooks
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: pre-commit-${{ runner.os }}-${{ hashFiles('.pre-commit-config.yaml') }}
          restore-keys: |
            pre-commit-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pre-commit
          pip install -e ".[dev]"

      - name: Run pre-commit hooks
        id: pre-commit
        run: |
          # Run pre-commit on all files changed in this PR/push
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "Running on files changed in PR..."
            git diff --name-only origin/${{ github.base_ref }}...HEAD | xargs -r pre-commit run --files
          else
            echo "Running on all files..."
            pre-commit run --all-files --show-diff-on-failure
          fi
        continue-on-error: true

      - name: Check for auto-fixes
        if: steps.pre-commit.outcome == 'failure'
        run: |
          # Check if any files were modified by auto-fix hooks
          if [ -n "$(git status --porcelain)" ]; then
            echo "::warning::Pre-commit hooks made changes. Please run 'pre-commit run --all-files' locally and commit the changes."
            git diff
            exit 1
          fi
          exit 0

      - name: Comment PR with results
        if: github.event_name == 'pull_request' && failure()
        uses: actions/github-script@v7
        with:
          script: |
            const message = `‚ùå **Pre-commit checks failed**

            Please run the following commands locally to fix the issues:

            \`\`\`bash
            pip install pre-commit
            pre-commit install
            pre-commit run --all-files
            \`\`\`

            Then commit and push the changes.`;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  security-scan:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: pre-commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install security tools
        run: |
          python -m pip install --upgrade pip
          pip install bandit[toml] safety detect-secrets
          pip install -e ".[dev]"

      - name: Run Bandit security scan
        run: |
          bandit -c pyproject.toml -r gaap/ -f json -o bandit-report.json || true
          bandit -c pyproject.toml -r gaap/ -ll

      - name: Upload Bandit report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bandit-security-report
          path: bandit-report.json
          retention-days: 30

      - name: Check for secrets
        run: |
          detect-secrets scan --baseline .secrets.baseline --all-files
          detect-secrets audit .secrets.baseline --report --fail-on-unaudited
        continue-on-error: true

  type-check:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: pre-commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Cache mypy
        uses: actions/cache@v4
        with:
          path: .mypy_cache
          key: mypy-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}-${{ github.sha }}
          restore-keys: |
            mypy-${{ runner.os }}-${{ hashFiles('**/pyproject.toml') }}-
            mypy-${{ runner.os }}-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install mypy types-PyYAML types-aiofiles types-requests
          pip install -e ".[dev]"

      - name: Run mypy type check
        run: |
          mypy gaap/ --ignore-missing-imports --show-error-codes --pretty

  lint-and-format:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: pre-commit

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install linting tools
        run: |
          python -m pip install --upgrade pip
          pip install ruff black isort

      - name: Check code formatting with Black
        run: |
          black --check --diff --line-length=100 gaap/ tests/ scripts/ examples/

      - name: Check import sorting with isort
        run: |
          isort --check-only --diff --profile=black --line-length=100 gaap/ tests/ scripts/ examples/

      - name: Run Ruff linter
        run: |
          ruff check gaap/ tests/ scripts/ examples/ --output-format=github

  coverage-check:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: [pre-commit, type-check]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pytest pytest-cov pytest-asyncio
          pip install -e ".[dev]"

      - name: Run tests with coverage
        run: |
          pytest tests/ -xvs --cov=gaap --cov-report=xml --cov-report=term-missing --cov-fail-under=80

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 30

      - name: Upload coverage to Codecov
        if: github.event_name == 'pull_request'
        uses: codecov/codecov-action@v4
        with:
          files: coverage.xml
          fail_ci_if_error: false
          verbose: true
